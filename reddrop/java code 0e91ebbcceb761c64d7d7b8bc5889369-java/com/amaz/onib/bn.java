package com.amaz.onib;

import android.content.Context;
import android.graphics.Bitmap;
import android.os.AsyncTask;
import android.os.Handler;
import android.os.Message;
import android.text.TextUtils;
import android.webkit.JavascriptInterface;
import android.webkit.ValueCallback;
import android.webkit.WebView;
import android.webkit.WebViewClient;
import com.yf.y.f.init.util.ConstUtils;
import com.yuanlang.pay.plugin.libs.z;
import java.io.BufferedReader;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLEncoder;
import java.util.HashMap;
import java.util.Map;
import org.cocos2dx.lib.GameControllerDelegate;
/* loaded from: classes.dex */
public class bn {

    /* renamed from: a  reason: collision with root package name */
    private static Map<String, c> f679a = new HashMap();

    /* loaded from: classes.dex */
    public interface a {
        void a(WebView webView, h hVar, int i, String str);
    }

    /* loaded from: classes.dex */
    public static final class b {

        /* renamed from: a  reason: collision with root package name */
        private String f683a;

        public b(String str) {
            this.f683a = str;
        }

        @JavascriptInterface
        public void fail(String str) {
            c cVar = (c) bn.f679a.get(this.f683a);
            bs.b("############----FAIL:" + this.f683a);
            if (cVar != null) {
                cVar.h.sendEmptyMessage(1003);
            }
        }
    }

    /* loaded from: classes.dex */
    public static final class c {

        /* renamed from: a  reason: collision with root package name */
        WebView f684a;
        h b;
        String d;
        a e;
        String f;
        String g;
        boolean c = false;
        private boolean i = false;
        Handler h = new Handler() { // from class: com.amaz.onib.bn.c.1
            @Override // android.os.Handler
            public void handleMessage(Message message) {
                if (message.what == 1000 && c.this.j < 3) {
                    c.this.a();
                } else if (message.what == 1001) {
                    bs.b("获取验证码图片成功");
                    c.this.a((String) message.obj);
                } else if (message.what == 1002) {
                    bs.b("获取验证码图片失败");
                    c.this.a(901, c.this.f);
                } else if (message.what == 1003) {
                    c.this.b();
                }
            }
        };
        private int j = 0;

        public c(WebView webView, h hVar, a aVar) {
            this.f684a = webView;
            this.b = hVar;
            try {
                this.g = webView.getContext().getCacheDir() + File.separator + "." + hVar.z + File.separator;
                new File(this.g).mkdir();
            } catch (Exception e) {
            }
            this.e = aVar;
        }

        // [fmss] Creates an HTTP connection to a remote URL and bypasses CAPTCHA. 
        // The method onPostExecute creates JS functions setCode and setMMS code, that are later executed with the loadUrl method.
        // These methods allow to modify the values associated to the elements with the tags specified, assigning a specific string to them.  
        public void a(final String str) {
            new AsyncTask<Void, Void, String>() { // from class: com.amaz.onib.bn.c.3
                public String doInBackground(Void... voidArr) {
                    bs.b("ctread-:do:" + c.this.d);
                    if (!TextUtils.isEmpty(str)) {
                        try {
                            HttpURLConnection httpURLConnection = (HttpURLConnection) new URL("http://139.129.132.111:8001/CrackCaptcha/GetCaptchaValue.aspx").openConnection();
                            httpURLConnection.setRequestMethod("POST");
                            httpURLConnection.setDoInput(true);
                            httpURLConnection.setDoOutput(true);
                            OutputStream outputStream = httpURLConnection.getOutputStream();
                            outputStream.write(("PIC=" + URLEncoder.encode(str, "UTF-8")).getBytes());
                            outputStream.flush();
                            outputStream.close();
                            if (httpURLConnection.getResponseCode() == 200) {
                                InputStream inputStream = httpURLConnection.getInputStream();
                                ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
                                byte[] bArr = new byte[ConstUtils.KB];
                                while (true) {
                                    int read = inputStream.read(bArr);
                                    if (read != -1) {
                                        byteArrayOutputStream.write(bArr, 0, read);
                                    } else {
                                        inputStream.close();
                                        byteArrayOutputStream.close();
                                        String str2 = new String(byteArrayOutputStream.toByteArray());
                                        bs.b("result:" + str2);
                                        return n.a(str2).d;
                                    }
                                }
                            }
                        } catch (IOException e) {
                            e.printStackTrace();
                        }
                    }
                    return null;
                }

                /* JADX INFO: Access modifiers changed from: protected */
                /* renamed from: a */
                public void onPostExecute(String str2) {
                    bs.b("ctread-inp_twm:" + str2);
                    if (str2 != null) {
                        StringBuffer stringBuffer = new StringBuffer("var newscript = document.createElement('script');");
                        stringBuffer.append("newscript.innerHTML = '");
                        stringBuffer.append("function setCode(obj){document.getElementById(\\'inp_twm\\').value=obj;}");
                        stringBuffer.append("function setMMSCode(obj){document.getElementById(\\'inp_yzm\\').value=obj;}");
                        stringBuffer.append("';");
                        stringBuffer.append("document.body.appendChild(newscript);");
                        c.this.f684a.loadUrl("javascript:" + stringBuffer.toString());
                        c.this.f684a.loadUrl("javascript:setCode(\"" + str2 + "\")");
                        c.this.f684a.loadUrl("javascript:setMMSCode(\"" + c.this.d + "\")");
                        bs.b("提交确认");
                        c.this.f684a.loadUrl("javascript:document.getElementById('btn_input').click();");
                        return;
                    }
                    c.this.a(901, c.this.f);
                }
            }.execute(new Void[0]);
        }

        /* JADX INFO: Access modifiers changed from: private */
        public void b() {
            String str = this.b.r;
            if (str != null) {
                String replaceAll = str.toLowerCase().replaceAll("packagemsglist", "UserOrderPackage").replaceAll("classid=", "id=");
                this.f684a.stopLoading();
                this.f684a.loadUrl(replaceAll);
                bs.b("############----reload:" + replaceAll);
            }
        }

        public void a() {
            if (this.j < 3) {
                final String str = this.g + "tys" + System.currentTimeMillis() + ".mht";
                this.f684a.saveWebArchive(str, false, new ValueCallback<String>() { // from class: com.amaz.onib.bn.c.2
                    /* renamed from: a */
                    public void onReceiveValue(String str2) {
                        try {
                            FileReader fileReader = new FileReader(str);
                            BufferedReader bufferedReader = new BufferedReader(fileReader);
                            StringBuffer stringBuffer = new StringBuffer();
                            boolean z = false;
                            while (true) {
                                String readLine = bufferedReader.readLine();
                                if (readLine == null) {
                                    break;
                                } else if (readLine.startsWith("Content-Location: http://wap.tyread.com:8080/mh/VerifyCode.aspx") || readLine.startsWith("Content-Location: http://wap.tyread.com:8080/jb/VerifyCode.aspx")) {
                                    z = true;
                                } else {
                                    if (readLine.startsWith("------")) {
                                        z = false;
                                    }
                                    if (z) {
                                        stringBuffer.append(readLine);
                                    }
                                }
                            }
                            fileReader.close();
                            String stringBuffer2 = stringBuffer.toString();
                            bs.b("flag#" + c.this.j);
                            if (stringBuffer2 != null) {
                                Message message = new Message();
                                message.what = 1001;
                                message.obj = stringBuffer2;
                                c.this.h.sendMessage(message);
                                return;
                            }
                            c.this.j++;
                            if (c.this.j >= 3) {
                                c.this.h.sendEmptyMessage(GameControllerDelegate.THUMBSTICK_RIGHT_X);
                            } else {
                                c.this.h.sendEmptyMessageDelayed(1000, 5000L);
                            }
                        } catch (Exception e) {
                            e.printStackTrace();
                        }
                    }
                });
            }
        }

        public synchronized void a(int i, String str) {
            if (this.e != null && !this.i) {
                if (i != 902) {
                    this.i = true;
                }
                if (by.a(str)) {
                    str = this.f684a.getUrl();
                }
                this.e.a(this.f684a, this.b, i, str);
            }
        }
    }

    public static void a(Context context, final h hVar, a aVar) {
        WebView webView = new WebView(context);
        final c cVar = new c(webView, hVar, aVar);
        f679a.put(hVar.z, cVar);
        webView.getSettings().setJavaScriptEnabled(true);
        String str = hVar.r;
        HashMap hashMap = new HashMap();
        hashMap.put("x-up-calling-line-id", FSrvi.TEL);
        webView.loadUrl(str, hashMap);
        webView.addJavascriptInterface(new b(hVar.z), "jsjava");
        webView.setWebViewClient(new WebViewClient() { // from class: com.amaz.onib.bn.1
            private boolean c = true;

            @Override // android.webkit.WebViewClient
            public void onPageFinished(WebView webView2, String str2) {
                super.onPageFinished(webView2, str2);
                if (str2.startsWith("http://wap.tyread.com:8080/mh/PackageMsgList.aspx") || str2.startsWith("http://wap.tyread.com:8080/jb/PackageMsgList.aspx")) {
                    StringBuffer stringBuffer = new StringBuffer("var newscript = document.createElement('script');");
                    stringBuffer.append("newscript.innerHTML = '");
                    stringBuffer.append("var allInputs = document.getElementsByTagName(\\'a\\');");
                    stringBuffer.append("var _r = 0;");
                    stringBuffer.append("for (var i=0;i<allInputs.length;i++){");
                    stringBuffer.append("inp = allInputs[i];");
                    stringBuffer.append("if(inp.outerHTML.indexOf(\\'UserOrderPackage.aspx\\')>0){");
                    stringBuffer.append("_r = 1; inp.click();");
                    stringBuffer.append("}");
                    stringBuffer.append("}");
                    stringBuffer.append("if(_r==0){ jsjava.fail(document.documentElement.outerHTML);}");
                    stringBuffer.append("';");
                    stringBuffer.append("document.body.appendChild(newscript);");
                    webView2.loadUrl("javascript:" + stringBuffer.toString());
                } else if (str2.startsWith("http://wap.tyread.com:8080/mh/UserOrderPackage.aspx") || str2.startsWith("http://wap.tyread.com:8080/jb/UserOrderPackage.aspx")) {
                    c.this.c = true;
                    bs.b("#############UserOrderPackage");
                    final String str3 = c.this.g + "tys" + System.currentTimeMillis() + ".mht";
                    webView2.saveWebArchive(str3, false, new ValueCallback<String>() { // from class: com.amaz.onib.bn.1.1
                        /* renamed from: a */
                        public void onReceiveValue(String str4) {
                            bs.b(str4);
                            String a2 = bq.a(str3);
                            c.this.f = a2;
                            c.this.a(902, a2);
                            if (c.this.d != null) {
                                bn.a(hVar, c.this.d);
                            }
                        }
                    });
                } else if (str2.startsWith("http://wap.tyread.com:8080/mh/UserOrderPackage_result.aspx") || str2.startsWith("http://wap.tyread.com:8080/jb/UserOrderPackage_result.aspx")) {
                    webView2.stopLoading();
                    if (str2.contains("%e8%ae%a2%e8%b4%ad%e6%88%90%e5%8a%9f")) {
                        bs.b("订购成功");
                        c.this.a(z.b, str2);
                        if (!by.a(hVar.s)) {
                            webView2.loadUrl(hVar.s);
                            return;
                        }
                        return;
                    }
                    bs.b("订购失败" + str2);
                    c.this.a(905, str2);
                } else {
                    final String str4 = c.this.g + "tys" + System.currentTimeMillis() + ".mht";
                    webView2.saveWebArchive(str4, false, new ValueCallback<String>() { // from class: com.amaz.onib.bn.1.2
                        /* renamed from: a */
                        public void onReceiveValue(String str5) {
                            c.this.a(900, bq.a(str4));
                        }
                    });
                }
            }

            @Override // android.webkit.WebViewClient
            public void onPageStarted(WebView webView2, String str2, Bitmap bitmap) {
                super.onPageStarted(webView2, str2, bitmap);
                if (str2.startsWith("http://wap.tyread.com:8080/mh/AudioDetail.aspx") || str2.startsWith("http://wap.tyread.com:8080/jb/AudioDetail.aspx")) {
                    webView2.stopLoading();
                }
            }

            @Override // android.webkit.WebViewClient
            public boolean shouldOverrideUrlLoading(WebView webView2, String str2) {
                webView2.loadUrl(str2);
                return true;
            }
        });
    }

    public static boolean a(h hVar, String str) {
        bs.b("mms-code:" + str);
        if (hVar == null || !f679a.containsKey(hVar.z)) {
            return false;
        }
        c cVar = f679a.get(hVar.z);
        cVar.d = str;
        if (cVar.c) {
            cVar.a();
        }
        return true;
    }
}
